import React, { useState, useEffect } from 'react';
import {
  View,
  Text,
  StyleSheet,
  TouchableOpacity,
  ScrollView,
  Alert,
  ActivityIndicator,
  Switch
} from 'react-native';
import AsyncStorage from '@react-native-async-storage/async-storage';
import UpdateService from '../services/updateService';

const UpdateSettingsScreen = ({ navigation }) => {
  const [isLoading, setIsLoading] = useState(false);
  const [autoUpdateEnabled, setAutoUpdateEnabled] = useState(true);
  const [updateInfo, setUpdateInfo] = useState(null);
  const [lastCheckTime, setLastCheckTime] = useState(null);

  useEffect(() => {
    loadUpdateSettings();
    loadUpdateInfo();
    loadLastCheckTime();
  }, []);

  const loadUpdateSettings = async () => {
    try {
      const enabled = await AsyncStorage.getItem('auto_update_enabled');
      if (enabled !== null) {
        setAutoUpdateEnabled(JSON.parse(enabled));
      }
    } catch (error) {
      console.error('ุฎุทุฃ ูู ุชุญููู ุฅุนุฏุงุฏุงุช ุงูุชุญุฏูุซ:', error);
    }
  };

  const loadUpdateInfo = async () => {
    try {
      const info = await UpdateService.getCurrentUpdateInfo();
      setUpdateInfo(info);
    } catch (error) {
      console.error('ุฎุทุฃ ูู ุชุญููู ูุนูููุงุช ุงูุชุญุฏูุซ:', error);
    }
  };

  const loadLastCheckTime = async () => {
    try {
      const lastCheck = await AsyncStorage.getItem(UpdateService.UPDATE_CHECK_KEY);
      if (lastCheck) {
        setLastCheckTime(new Date(parseInt(lastCheck)));
      }
    } catch (error) {
      console.error('ุฎุทุฃ ูู ุชุญููู ููุช ุขุฎุฑ ูุญุต:', error);
    }
  };

  const toggleAutoUpdate = async (value) => {
    try {
      setAutoUpdateEnabled(value);
      await AsyncStorage.setItem('auto_update_enabled', JSON.stringify(value));
      
      Alert.alert(
        'ุชู ุญูุธ ุงูุฅุนุฏุงุฏุงุช',
        value 
          ? 'ุชู ุชูุนูู ุงูุชุญูู ุงูุชููุงุฆู ูู ุงูุชุญุฏูุซุงุช'
          : 'ุชู ุฅููุงู ุงูุชุญูู ุงูุชููุงุฆู ูู ุงูุชุญุฏูุซุงุช',
        [{ text: 'ููุงูู', style: 'default' }]
      );
    } catch (error) {
      console.error('ุฎุทุฃ ูู ุญูุธ ุฅุนุฏุงุฏุงุช ุงูุชุญุฏูุซ:', error);
    }
  };

  const handleManualCheck = async () => {
    setIsLoading(true);
    try {
      await UpdateService.manualUpdateCheck();
      await loadLastCheckTime();
    } catch (error) {
      console.error('ุฎุทุฃ ูู ุงููุญุต ุงููุฏูู:', error);
    } finally {
      setIsLoading(false);
    }
  };

  const handleClearCache = async () => {
    Alert.alert(
      'ูุณุญ ุงูุชุฎุฒูู ุงููุคูุช',
      'ูู ุฃูุช ูุชุฃูุฏ ูู ุฃูู ุชุฑูุฏ ูุณุญ ุจูุงูุงุช ุงูุชุญุฏูุซุงุช ุงููุคูุชุฉุ',
      [
        { text: 'ุฅูุบุงุก', style: 'cancel' },
        {
          text: 'ูุณุญ',
          style: 'destructive',
          onPress: async () => {
            await UpdateService.clearUpdateCache();
            await loadLastCheckTime();
          }
        }
      ]
    );
  };

  const formatDate = (date) => {
    if (!date) return 'ุบูุฑ ูุชููุฑ';
    return date.toLocaleString('ar-EG', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  };

  return (
    <ScrollView style={styles.container}>
      {/* ุชุญุฐูุฑ ูุถุน ุงูุชุทููุฑ */}
      {updateInfo?.isDevelopment && (
        <View style={styles.warningSection}>
          <Text style={styles.warningTitle}>๐ง ูุถุน ุงูุชุทููุฑ</Text>
          <Text style={styles.warningText}>
            ุงูุชุญุฏูุซุงุช ุงูุชููุงุฆูุฉ ูุง ุชุนูู ูู Expo Go ุฃู ูุถุน ุงูุชุทููุฑ.
            ุณุชุนูู ููุท ุนูุฏ ูุดุฑ ุงูุชุทุจูู ูู APK ุฃู ูู ูุชุฌุฑ ุงูุชุทุจููุงุช.
          </Text>
        </View>
      )}

      <View style={styles.section}>
        <Text style={styles.sectionTitle}>ุฅุนุฏุงุฏุงุช ุงูุชุญุฏูุซ</Text>
        
        <View style={styles.settingItem}>
          <View style={styles.settingInfo}>
            <Text style={styles.settingTitle}>ุงูุชุญูู ุงูุชููุงุฆู ูู ุงูุชุญุฏูุซุงุช</Text>
            <Text style={styles.settingDescription}>
              {updateInfo?.isDevelopment 
                ? 'ุบูุฑ ูุชุงุญ ูู ูุถุน ุงูุชุทููุฑ' 
                : 'ูุญุต ุงูุชุญุฏูุซุงุช ุชููุงุฆูุงู ุนูุฏ ูุชุญ ุงูุชุทุจูู'
              }
            </Text>
          </View>
          <Switch
            value={autoUpdateEnabled}
            onValueChange={toggleAutoUpdate}
            disabled={updateInfo?.isDevelopment}
            trackColor={{ false: '#767577', true: '#81b0ff' }}
            thumbColor={autoUpdateEnabled ? '#f5dd4b' : '#f4f3f4'}
          />
        </View>
      </View>

      <View style={styles.section}>
        <Text style={styles.sectionTitle}>ุฅุฌุฑุงุกุงุช ุงูุชุญุฏูุซ</Text>
        
        <TouchableOpacity
          style={[
            styles.button, 
            styles.checkButton, 
            updateInfo?.isDevelopment && styles.disabledButton
          ]}
          onPress={handleManualCheck}
          disabled={isLoading || updateInfo?.isDevelopment}
        >
          {isLoading ? (
            <ActivityIndicator color="#fff" size="small" />
          ) : (
            <Text style={styles.buttonText}>
              {updateInfo?.isDevelopment ? 'ุบูุฑ ูุชุงุญ ูู ูุถุน ุงูุชุทููุฑ' : 'ูุญุต ุงูุชุญุฏูุซุงุช ุงูุขู'}
            </Text>
          )}
        </TouchableOpacity>

        <TouchableOpacity
          style={[styles.button, styles.clearButton]}
          onPress={handleClearCache}
        >
          <Text style={styles.buttonText}>ูุณุญ ุงูุชุฎุฒูู ุงููุคูุช</Text>
        </TouchableOpacity>
      </View>

      <View style={styles.section}>
        <Text style={styles.sectionTitle}>ูุนูููุงุช ุงูุชุญุฏูุซ</Text>
        
        <View style={styles.infoItem}>
          <Text style={styles.infoLabel}>ุขุฎุฑ ูุญุต ููุชุญุฏูุซุงุช:</Text>
          <Text style={styles.infoValue}>{formatDate(lastCheckTime)}</Text>
        </View>

        {updateInfo && (
          <>
            <View style={styles.infoItem}>
              <Text style={styles.infoLabel}>ุฅุตุฏุงุฑ ุงูุชุดุบูู:</Text>
              <Text style={styles.infoValue}>{updateInfo.runtimeVersion || 'ุบูุฑ ูุชููุฑ'}</Text>
            </View>

            <View style={styles.infoItem}>
              <Text style={styles.infoLabel}>ููุงุฉ ุงูุชุญุฏูุซ:</Text>
              <Text style={styles.infoValue}>{updateInfo.channel || 'default'}</Text>
            </View>

            <View style={styles.infoItem}>
              <Text style={styles.infoLabel}>ููุน ุงูุฅุทูุงู:</Text>
              <Text style={styles.infoValue}>
                {updateInfo.isEmbeddedLaunch 
                  ? 'ูุฏูุฌ ูู ุงูุชุทุจูู' 
                  : updateInfo.isEmergencyLaunch 
                    ? 'ุทูุงุฑุฆ' 
                    : 'ุชุญุฏูุซ OTA'
                }
              </Text>
            </View>

            {updateInfo.updateId && (
              <View style={styles.infoItem}>
                <Text style={styles.infoLabel}>ูุนุฑู ุงูุชุญุฏูุซ:</Text>
                <Text style={[styles.infoValue, styles.updateId]}>
                  {updateInfo.updateId.substring(0, 8)}...
                </Text>
              </View>
            )}
          </>
        )}
      </View>

      <View style={styles.section}>
        <Text style={styles.sectionTitle}>ูุตุงุฆุญ ูููุฉ</Text>
        <View style={styles.tipsContainer}>
          <Text style={styles.tipText}>
            โข ุงูุชุญุฏูุซุงุช ุงูุชููุงุฆูุฉ ุชุนูู ููุท ูุน ุงูุชุทุจููุงุช ุงูููุดูุฑุฉุ ูููุณ ูู Expo Go
          </Text>
          <Text style={styles.tipText}>
            โข ูู ูุถุน ุงูุชุทููุฑุ ุณุชุญุชุงุฌ ููุดุฑ ุงูุชุทุจูู ูู APK ุฃู ูู ูุชุฌุฑ ุงูุชุทุจููุงุช
          </Text>
          <Text style={styles.tipText}>
            โข ุชุฃูุฏ ูู ุงุชุตุงูู ุจุงูุฅูุชุฑูุช ููุญุตูู ุนูู ุงูุชุญุฏูุซุงุช
          </Text>
          <Text style={styles.tipText}>
            โข ุฅุฐุง ูุงุฌูุช ูุดุงููุ ุฌุฑุจ ูุณุญ ุงูุชุฎุฒูู ุงููุคูุช
          </Text>
          <Text style={styles.tipText}>
            โข ุงูุชุญุฏูุซุงุช ูุง ุชุคุซุฑ ุนูู ุงูุจูุงูุงุช ุงููุญููุธุฉ ูุญููุงู
          </Text>
        </View>
      </View>
    </ScrollView>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#f5f5f5',
  },
  section: {
    backgroundColor: '#fff',
    marginHorizontal: 15,
    marginVertical: 10,
    borderRadius: 10,
    padding: 15,
    shadowColor: '#000',
    shadowOffset: {
      width: 0,
      height: 2,
    },
    shadowOpacity: 0.1,
    shadowRadius: 3.84,
    elevation: 5,
  },
  sectionTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    color: '#333',
    marginBottom: 15,
    textAlign: 'right',
  },
  settingItem: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    paddingVertical: 10,
  },
  settingInfo: {
    flex: 1,
    marginRight: 15,
  },
  settingTitle: {
    fontSize: 16,
    fontWeight: '600',
    color: '#333',
    textAlign: 'right',
    marginBottom: 5,
  },
  settingDescription: {
    fontSize: 14,
    color: '#666',
    textAlign: 'right',
  },
  button: {
    backgroundColor: '#007AFF',
    paddingVertical: 12,
    paddingHorizontal: 20,
    borderRadius: 8,
    marginVertical: 5,
    alignItems: 'center',
  },
  checkButton: {
    backgroundColor: '#34C759',
  },
  clearButton: {
    backgroundColor: '#FF3B30',
  },
  buttonText: {
    color: '#fff',
    fontSize: 16,
    fontWeight: '600',
  },
  infoItem: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    paddingVertical: 8,
    borderBottomWidth: 1,
    borderBottomColor: '#f0f0f0',
  },
  infoLabel: {
    fontSize: 14,
    color: '#666',
    flex: 1,
    textAlign: 'right',
  },
  infoValue: {
    fontSize: 14,
    color: '#333',
    fontWeight: '500',
    flex: 1,
    textAlign: 'left',
  },
  updateId: {
    fontFamily: 'monospace',
  },
  warningSection: {
    backgroundColor: '#fff3cd',
    marginHorizontal: 15,
    marginVertical: 10,
    borderRadius: 10,
    padding: 15,
    borderLeftWidth: 4,
    borderLeftColor: '#ffc107',
  },
  warningTitle: {
    fontSize: 16,
    fontWeight: 'bold',
    color: '#856404',
    marginBottom: 10,
    textAlign: 'right',
  },
  warningText: {
    fontSize: 14,
    color: '#856404',
    textAlign: 'right',
    lineHeight: 20,
  },
  disabledButton: {
    backgroundColor: '#6c757d',
    opacity: 0.6,
  },
  tipsContainer: {
    backgroundColor: '#f8f9fa',
    borderRadius: 8,
    padding: 15,
  },
  tipText: {
    fontSize: 14,
    color: '#666',
    textAlign: 'right',
    marginBottom: 8,
    lineHeight: 20,
  },
});

export default UpdateSettingsScreen;
